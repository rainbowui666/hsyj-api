{
    "version": 3,
    "sources": [
        "../../../src/api/controller/auth.js"
    ],
    "names": [
        "Base",
        "require",
        "svgCaptcha",
        "http",
        "module",
        "exports",
        "loginAction",
        "code",
        "post",
        "fullUserInfo",
        "tel",
        "schoolid",
        "studentname",
        "stuNo",
        "newUserInfo",
        "model",
        "where",
        "studentName",
        "find",
        "TokenSerivce",
        "service",
        "sessionKey",
        "create",
        "user_id",
        "studentID",
        "think",
        "isEmpty",
        "fail",
        "success",
        "token",
        "userInfo",
        "logoutAction",
        "createCaptchaAction",
        "captcha",
        "inverse",
        "fontSize",
        "noise",
        "width",
        "height",
        "ctx",
        "req",
        "session",
        "text",
        "toLowerCase",
        "console",
        "log",
        "cache",
        "type",
        "res",
        "write",
        "String",
        "data",
        "end"
    ],
    "mappings": ";;AAAA,MAAMA,OAAOC,QAAQ,WAAR,CAAb;AACA,IAAIC,aAAaD,QAAQ,aAAR,CAAjB;AACA,IAAIE,OAAOF,QAAQ,MAAR,CAAX;;AAEAG,OAAOC,OAAP,GAAiB,cAAcL,IAAd,CAAmB;AAC5BM,aAAN,GAAoB;AAAA;;AAAA;AAClB,YAAMC,OAAO,MAAKC,IAAL,CAAU,MAAV,CAAb;AACA,YAAMC,eAAe,MAAKD,IAAL,CAAU,UAAV,CAArB;AACA,YAAME,MAAM,MAAKF,IAAL,CAAU,KAAV,CAAZ;AACA,YAAMG,WAAW,MAAKH,IAAL,CAAU,UAAV,CAAjB;AACA,YAAMI,cAAc,MAAKJ,IAAL,CAAU,aAAV,CAApB;AACA,YAAMK,QAAQ,MAAKL,IAAL,CAAU,OAAV,CAAd;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACE;AACF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA,YAAMM,cAAc,MAAM,MAAKC,KAAL,CAAW,SAAX,EAAsBC,KAAtB,CAA4B,EAAEN,KAAIA,GAAN,EAAWC,UAASA,QAApB,EAA6BM,aAAYL,WAAzC,EAAsDC,OAAMA,KAA5D,EAA5B,EAAiGK,IAAjG,EAA1B;;AAEA,YAAMC,eAAe,MAAKC,OAAL,CAAa,OAAb,EAAsB,KAAtB,CAArB;AACA,YAAMC,aAAa,MAAMF,aAAaG,MAAb,CAAoB,EAAEC,SAAST,YAAYU,SAAvB,EAApB,CAAzB;;AAEA,UAAIC,MAAMC,OAAN,CAAcZ,WAAd,KAA8BW,MAAMC,OAAN,CAAcL,UAAd,CAAlC,EAA6D;AAC3D,eAAO,MAAKM,IAAL,CAAU,MAAV,CAAP;AACD;;AAED,aAAO,MAAKC,OAAL,CAAa,EAAEC,OAAOR,UAAT,EAAqBS,UAAUhB,WAA/B,EAAb,CAAP;AAvCkB;AAwCnB;;AAGKiB,cAAN,GAAqB;AAAA;;AAAA;AACnB,aAAO,OAAKH,OAAL,EAAP;AADmB;AAEpB;;AAEKI,qBAAN,GAA4B;AAAA;;AAAA;AAC1B,UAAIC,UAAU/B,WAAWoB,MAAX,CAAkB;AAC9B;AACAY,iBAAS,KAFqB;AAG9B;AACAC,kBAAU,EAJoB;AAK9B;AACAC,eAAO,CANuB;AAO9B;AACAC,eAAO,EARuB;AAS9B;AACAC,gBAAQ;AAVsB,OAAlB,CAAd;AAYA;AACA,aAAKC,GAAL,CAASC,GAAT,CAAaC,OAAb,GAAuBR,QAAQS,IAAR,CAAaC,WAAb,EAAvB;AACAC,cAAQC,GAAR,CAAY,OAAKN,GAAL,CAASC,GAAT,CAAaC,OAAzB,EAf0B,CAeS;AACnC;AACA,aAAKK,KAAL,CAAW,SAAX,EAAsB,OAAKP,GAAL,CAASC,GAAT,CAAaC,OAAnC;AACA,aAAKF,GAAL,CAASQ,IAAT,GAAiB,eAAjB;AACA,aAAKR,GAAL,CAASS,GAAT,CAAaC,KAAb,CAAmBC,OAAOjB,QAAQkB,IAAf,CAAnB;AACA,aAAKZ,GAAL,CAASS,GAAT,CAAaI,GAAb;AApB0B;AAqB3B;;AArEiC,CAApC",
    "file": "../../../src/api/controller/auth.js",
    "sourcesContent": [
        "const Base = require('./base.js');\nvar svgCaptcha = require('svg-captcha');\nvar http = require('http');\n\nmodule.exports = class extends Base {\n  async loginAction() {\n    const code = this.post('code');\n    const fullUserInfo = this.post('userInfo');\n    const tel = this.post('tel');\n    const schoolid = this.post('schoolid');\n    const studentname = this.post('studentname');\n    const stuNo = this.post('stuno');\n\n    // 解释用户数据\n    // const userInfo = await this.service('weixin', 'api').login(code, fullUserInfo);\n    // if (think.isEmpty(userInfo)) {\n    //   return this.fail('登录失败');\n    // }\n\n    // 根据openid查找用户是否已经注册\n    // let userId = await this.model('student').where({ wxopenid: userInfo.openId }).getField('studentId', true);\n    // if (think.isEmpty(userId)) {\n      // 注册\n    //   userId = await this.model('user').add({\n    //     username: '微信用户' + think.uuid(6),\n    //     pwd: '',\n    //     tel: '',\n    //     wxopenid: userInfo.openId,\n    //     photo: userInfo.avatarUrl || '',\n    //     sex: userInfo.gender || 1, // 性别 0：未知、1：男、2：女\n    //     nickname: userInfo.nickName\n    //   });\n    // }\n\n    // 查询用户信息\n    const newUserInfo = await this.model('student').where({ tel:tel, schoolid:schoolid,studentName:studentname, stuNo:stuNo }).find();\n\n    const TokenSerivce = this.service('token', 'api');\n    const sessionKey = await TokenSerivce.create({ user_id: newUserInfo.studentID });\n\n    if (think.isEmpty(newUserInfo) || think.isEmpty(sessionKey)) {\n      return this.fail('登录失败');\n    }\n\n    return this.success({ token: sessionKey, userInfo: newUserInfo });\n  }\n\n  \n  async logoutAction() {\n    return this.success();\n  }\n\n  async createCaptchaAction() {\n    var captcha = svgCaptcha.create({  \n      // 翻转颜色  \n      inverse: false,  \n      // 字体大小  \n      fontSize: 36,  \n      // 噪声线条数  \n      noise: 2,  \n      // 宽度  \n      width: 80,  \n      // 高度  \n      height: 30,  \n    });  \n    // 保存到session,忽略大小写  \n    this.ctx.req.session = captcha.text.toLowerCase(); \n    console.log(this.ctx.req.session); //0xtg 生成的验证码\n    //保存到cookie 方便前端调用验证\n    this.cache('captcha', this.ctx.req.session); \n    this.ctx.type = ('image/svg+xml');\n    this.ctx.res.write(String(captcha.data));\n    this.ctx.res.end();\n  }\n\n\n};\n"
    ]
}