{
    "version": 3,
    "sources": [
        "../../../src/api/controller/upload.js"
    ],
    "names": [
        "Base",
        "require",
        "fs",
        "_",
        "module",
        "exports",
        "indexAction",
        "display",
        "uploadFileAction",
        "self",
        "fileInfo",
        "file",
        "think",
        "isEmpty",
        "fail",
        "that",
        "extension",
        "name",
        "indexOf",
        "exname",
        "uuid",
        "filename",
        "config",
        "is",
        "createReadStream",
        "path",
        "os",
        "createWriteStream",
        "pipe",
        "json",
        "error",
        "errmsg",
        "success",
        "wxUploadAction",
        "sourcetype",
        "post",
        "insertid",
        "img",
        "_name",
        "tempName",
        "split",
        "length",
        "thumbUrl",
        "thumbSmallUrl",
        "userid",
        "ctx",
        "state",
        "userId",
        "renameSync",
        "console",
        "log",
        "imgObj",
        "model",
        "add",
        "sourceType",
        "sourceAddress",
        "targetid"
    ],
    "mappings": "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",
    "file": "../../../src/api/controller/upload.js",
    "sourcesContent": [
        "const Base = require('./base.js');\nconst fs = require('fs');\nconst _ = require('lodash');\n// const images = require('images');\n\nmodule.exports = class extends Base {\n    indexAction(){\n        this.display();\n    }\n\n    uploadFileAction() {\n        var self = this;\n        var fileInfo = this.file('qqfile');\n\n        if (think.isEmpty(fileInfo)) {\n            return this.fail('保存失败');\n          }\n          const that = this;\n          let extension = fileInfo.name;\n          if (extension.indexOf('.jpg') != -1 || extension.indexOf('.jpg') != -1) {\n            extension = '.jpg'\n          } else if (extension.indexOf('.png') != -1) {\n            extension = '.png'\n          } else if (extension.indexOf('.mp3') != -1) {\n            extension = '.mp3'\n          } else if (extension.indexOf('.mp4') != -1) {\n            extension = '.mp4'\n          }\n        //   const filename = '/static/upload/' + think.uuid(16) + extension;\n        let exname = think.uuid(16) + extension;\n        const filename = this.config('image.user')+ exname;\n      \n          const is = fs.createReadStream(fileInfo.path);\n          const os = fs.createWriteStream(filename);\n          is.pipe(os);\n\n        if(fileInfo) {\n            self.json({\n                error: 0,\n                errmsg: 'ok',\n                filename: exname,\n                success: true //只有success返回true才认为上传成功\n            });\n        }else {\n            self.error();\n        }\n    }\n\n    async wxUploadAction() {\n      const sourcetype = this.post('sourcetype');\n      const insertid = this.post('insertid');\n\n      const img = this.file('file');\n      const _name = img.name;\n\n      const tempName = _name.split('.');\n      // const timestamp = _.uniqueId('shculture');\n      const name = think.uuid(2) + '-' + insertid + '.' + tempName[tempName.length - 1];\n      const thumbUrl = this.config('image.user') + '/' + name;\n      const thumbSmallUrl = this.config('image.user') + '/small/' + name;\n      const userid = this.ctx.state.userId;\n\n      fs.renameSync(img.path, thumbUrl);\n      // images(thumbUrl + '').resize(96).save(thumbSmallUrl);\n      console.log('wxupdload', thumbUrl, thumbSmallUrl, name, userid)\n      if (userid != 0) {\n        const imgObj = await this.model('source').add({ sourceType: sourcetype, sourceAddress: 'https://cdn.100eduonline.com/images/'+name,targetid: insertid, userid: userid });\n        return this.json(imgObj);\n      } else {\n        return this.fail('登录信息过期,请重新登录')\n      }\n    }\n    // async upload2Action() {\n    //     const circleId = this.post('circleId');\n    //     const img = this.file('file');\n    //     const _name = img.name;\n    //     const tempName = _name.split('.');\n    //     const timestamp = _.uniqueId('circle');\n    //     const name = timestamp + '-' + circleId + '.' + tempName[tempName.length - 1];\n    //     const thumbUrl = this.config('image.circle') + '/' + name;\n    //     const thumbSmallUrl = this.config('image.circle') + '/small/' + name;\n    //     fs.renameSync(img.path, thumbUrl);\n    //     images(thumbUrl + '').resize(96).save(thumbSmallUrl);\n    //     const imgObj = await this.model('circle_img').add({ circle_id: circleId, url: 'https://static.huanjiaohu.com/image/circle/small/' + name });\n    //     return this.json(imgObj);\n    //   }\n};"
    ]
}