{
    "version": 3,
    "sources": [
        "../../../src/api/controller/discuss.js"
    ],
    "names": [
        "Base",
        "require",
        "module",
        "exports",
        "uncodeUtf16",
        "str",
        "reg",
        "result",
        "replace",
        "char",
        "H",
        "L",
        "code",
        "length",
        "parseInt",
        "match",
        "Math",
        "floor",
        "unescape",
        "toString",
        "utf16toEntities",
        "patt",
        "charCodeAt",
        "addAction",
        "distype",
        "get",
        "targetid",
        "studentid",
        "scenerytype",
        "content",
        "post",
        "shstate",
        "console",
        "log",
        "model",
        "data",
        "think",
        "isEmpty",
        "insertid",
        "add",
        "success",
        "listAction",
        "pageindex",
        "pagesize",
        "sceneryid",
        "activityID",
        "schoolid",
        "typeconition",
        "scenerycondition",
        "activitycondition",
        "schoolcondition",
        "statusconditionn",
        "studentcondition",
        "id",
        "start",
        "query",
        "counta",
        "i",
        "pagecount",
        "ceil",
        "t",
        "getdatabyname",
        "name",
        "_pk",
        "dataname",
        "where",
        "cachename",
        "select",
        "cache",
        "delete",
        "homeDiscussAction",
        "homedata",
        "order",
        "page",
        "countSelect",
        "arrdata",
        "item",
        "pics",
        "getPicsbyid",
        "isgroup",
        "getField",
        "likednum",
        "discussid",
        "discussID",
        "count",
        "poto",
        "field",
        "studentID",
        "find",
        "push",
        "likediscussAction",
        "clicknum",
        "para",
        "update",
        "clickdata",
        "json",
        "msg",
        "newnum",
        "hasLikeDiscussAction"
    ],
    "mappings": ";;AAAA,MAAMA,OAAOC,QAAQ,WAAR,CAAb;;AAEAC,OAAOC,OAAP,GAAiB,cAAcH,IAAd,CAAmB;;AAEhCI,gBAAYC,GAAZ,EAAgB;AACZ,YAAIC,MAAM,UAAV;AACA,YAAIC,SAASF,IAAIG,OAAJ,CAAYF,GAAZ,EAAgB,UAASG,IAAT,EAAc;AACvC,gBAAIC,CAAJ,EAAMC,CAAN,EAAQC,IAAR;AACA,gBAAGH,KAAKI,MAAL,IAAe,CAAlB,EAAqB;AACjBD,uBAAOE,SAASL,KAAKM,KAAL,CAAW,SAAX,CAAT,CAAP;AACAL,oBAAIM,KAAKC,KAAL,CAAW,CAACL,OAAK,OAAN,IAAiB,KAA5B,IAAmC,MAAvC;AACAD,oBAAI,CAACC,OAAO,OAAR,IAAmB,KAAnB,GAA2B,MAA/B;AACA,uBAAOM,SAAS,OAAKR,EAAES,QAAF,CAAW,EAAX,CAAL,GAAoB,IAApB,GAAyBR,EAAEQ,QAAF,CAAW,EAAX,CAAlC,CAAP;AACH,aALD,MAKK;AACD,uBAAOV,IAAP;AACH;AACJ,SAVY,CAAb;AAWA,eAAOF,MAAP;AACF;;AAEFa,oBAAgBf,GAAhB,EAAqB;AACjB,YAAIgB,OAAK,iCAAT;AACA;AACAhB,cAAMA,IAAIG,OAAJ,CAAYa,IAAZ,EAAkB,UAASZ,IAAT,EAAc;AAClC,gBAAIC,CAAJ,EAAOC,CAAP,EAAUC,IAAV;AACA,gBAAIH,KAAKI,MAAL,KAAc,CAAlB,EAAqB;AACjBH,oBAAID,KAAKa,UAAL,CAAgB,CAAhB,CAAJ;AACA;AACAX,oBAAIF,KAAKa,UAAL,CAAgB,CAAhB,CAAJ;AACA;AACAV,uBAAO,CAACF,IAAI,MAAL,IAAe,KAAf,GAAuB,OAAvB,GAAiCC,CAAjC,GAAqC,MAA5C;AACA;AACA,uBAAO,OAAOC,IAAP,GAAc,GAArB;AACH,aARD,MAQO;AACH,uBAAOH,IAAP;AACH;AACJ,SAbK,CAAN;AAcA,eAAOJ,GAAP;AACH;;AAEKkB,aAAN,GAAkB;AAAA;;AAAA;AACd,kBAAMC,UAAU,MAAKC,GAAL,CAAS,SAAT,CAAhB;AACA,kBAAMC,WAAW,MAAKD,GAAL,CAAS,UAAT,KAAwB,CAAzC;AACA,kBAAME,YAAY,MAAKF,GAAL,CAAS,WAAT,CAAlB;AACA,kBAAMG,cAAc,MAAKH,GAAL,CAAS,aAAT,CAApB;AACA,kBAAMI,UAAU,MAAKT,eAAL,CAAqB,MAAKU,IAAL,CAAU,SAAV,CAArB,CAAhB;AACA,kBAAMC,UAAU,MAAKD,IAAL,CAAU,SAAV,KAAwB,CAAxC;;AAEAE,oBAAQC,GAAR,CAAY,SAAZ,EAAuBJ,OAAvB;;AAEA,kBAAMK,QAAQ,MAAKA,KAAL,CAAW,SAAX,CAAd;AACA,gBAAIC,OAAO,IAAX;AACA,gBAAIC,MAAMC,OAAN,CAAcT,WAAd,CAAJ,EAAgC;AAC5BO,uBAAO;AACHX,2BADG,EACKE,QADL,EACcC,SADd,EACwBE,OADxB,EACgCE;AADhC,iBAAP;AAGH,aAJD,MAIO;AACHI,uBAAO;AACHX,2BADG,EACKE,QADL,EACcC,SADd,EACwBE,OADxB,EACgCE,OADhC,EACwCH;AADxC,iBAAP;AAGH;;AAED,gBAAIU,WAAW,MAAMJ,MAAMK,GAAN,CAAUJ,IAAV,CAArB;AACA,mBAAO,MAAKK,OAAL,CAAa,MAAb,CAAP;AAvBc;AAwBjB;;AAEKC,cAAN,GAAmB;AAAA;;AAAA;AACf,kBAAMP,QAAS,OAAKA,KAAL,CAAW,SAAX,CAAf;AACA,kBAAMQ,YAAY,OAAKjB,GAAL,CAAS,WAAT,KAAyB,CAA3C;AACA,kBAAMkB,WAAW,OAAKlB,GAAL,CAAS,UAAT,KAAwB,CAAzC;AACA,kBAAMM,UAAU,OAAKN,GAAL,CAAS,SAAT,CAAhB;AACA,kBAAMD,UAAU,OAAKC,GAAL,CAAS,SAAT,CAAhB;AACA,kBAAMmB,YAAY,OAAKnB,GAAL,CAAS,WAAT,CAAlB;AACA,kBAAMoB,aAAa,OAAKpB,GAAL,CAAS,YAAT,CAAnB;AACA,kBAAMqB,WAAW,OAAKrB,GAAL,CAAS,UAAT,CAAjB;AACA,kBAAME,YAAY,OAAKF,GAAL,CAAS,WAAT,CAAlB;;AAEA,gBAAIsB,eAAe,EAAnB;AACA,gBAAIC,mBAAmB,EAAvB;AACA,gBAAIC,oBAAoB,EAAxB;AACA,gBAAIC,kBAAkB,EAAtB;AACA,gBAAIC,mBAAmB,EAAvB;AACA,gBAAIC,mBAAmB,EAAvB;;AAEA,gBAAIhB,MAAMC,OAAN,CAAcN,OAAd,CAAJ,EAA4B;AACxBoB,mCAAmB,MAAnB;AACH,aAFD,MAEO;AACHA,mCAAmB,eAAapB,OAAhC;AACH;;AAED,gBAAIK,MAAMC,OAAN,CAAcb,OAAd,CAAJ,EAA4B;AACxBuB,+BAAe,MAAf;AACH,aAFD,MAEO;AACH,oBAAIM,KAAK,CAAC,CAAV;AACA,oBAAI7B,WAAW,CAAf,EAAkB;AACd6B,yBAAKT,SAAL;AACH,iBAFD,MAEO,IAAIpB,WAAW,CAAf,EAAkB;AACrB6B,yBAAKR,UAAL;AACH,iBAFM,MAEA,IAAIrB,WAAW,CAAf,EAAkB;AACrB6B,yBAAKP,QAAL;AACH,iBAFM,MAEA,IAAItB,WAAW,CAAf,EAAkB;AACrB6B,yBAAK,CAAL;AACH;AACD,oBAAG,CAACjB,MAAMC,OAAN,CAAcgB,EAAd,CAAJ,EAAuB;AACnBN,mCAAe,eAAavB,OAAb,GAAqB,kBAArB,GAAwC6B,EAAvD;AACH,iBAFD,MAEO;AACHN,mCAAe,eAAavB,OAA5B;AACH;AACJ;;AAED,gBAAIY,MAAMC,OAAN,CAAcO,SAAd,CAAJ,EAA8B;AAC1BI,mCAAmB,MAAnB;AACH,aAFD,MAEO;AACHA,mCAAmB,eAAaJ,SAAhC;AACH;;AAED,gBAAIR,MAAMC,OAAN,CAAcQ,UAAd,CAAJ,EAA+B;AAC3BI,oCAAoB,MAApB;AACH,aAFD,MAEO;AACHA,oCAAoB,gBAAcJ,UAAlC;AACH;;AAED,gBAAIT,MAAMC,OAAN,CAAcS,QAAd,CAAJ,EAA6B;AACzBI,kCAAkB,MAAlB;AACH,aAFD,MAEO;AACHA,kCAAkB,cAAYJ,QAA9B;AACH;;AAED,gBAAIV,MAAMC,OAAN,CAAcV,SAAd,CAAJ,EAA8B;AAC1ByB,mCAAmB,MAAnB;AACH,aAFD,MAEO;AACHA,mCAAmB,iBAAezB,SAAlC;AACH;AACD,kBAAM2B,QAAQ,CAACZ,YAAW,CAAZ,IAAiBC,QAA/B;AACA,kBAAMR,OAAO,MAAMD,MAAMqB,KAAN,CAAY,uNAAqNP,gBAArN,GAAsO,iFAAtO,GAAwTC,iBAAxT,GAA0U,6EAA1U,GAAwZC,eAAxZ,GAAwa,mJAAxa,GAA4jBH,YAA5jB,GAAykB,OAAzkB,GAAilBK,gBAAjlB,GAAkmB,OAAlmB,GAA0mBD,gBAA1mB,GAA2nB,iDAA3nB,GAA6qBG,KAA7qB,GAAmrB,GAAnrB,GAAurBX,QAAvrB,GAAgsB,GAA5sB,CAAnB;AACA,kBAAMa,SAAS,MAAMtB,MAAMqB,KAAN,CAAY,+LAA6LP,gBAA7L,GAA8M,iFAA9M,GAAgSC,iBAAhS,GAAkT,6EAAlT,GAAgYC,eAAhY,GAAgZ,mJAAhZ,GAAoiBH,YAApiB,GAAijB,OAAjjB,GAAyjBK,gBAAzjB,GAA0kB,OAA1kB,GAAklBD,gBAAllB,GAAmmB,sBAA/mB,CAArB;AACA,gBAAI,CAACf,MAAMC,OAAN,CAAcF,IAAd,CAAD,IAAwBA,KAAKtB,MAAL,GAAc,CAA1C,EAA6C;AACzC,qBAAK,IAAI4C,IAAI,CAAb,EAAgBA,IAAItB,KAAKtB,MAAzB,EAAiC4C,GAAjC,EAAsC;AAClCtB,yBAAKsB,CAAL,EAAQ5B,OAAR,GAAkB,OAAKzB,WAAL,CAAiB+B,KAAKsB,CAAL,EAAQ5B,OAAzB,CAAlB;AACH;AACJ;;AAED,kBAAM6B,YAAY1C,KAAK2C,IAAL,CAAUH,OAAO,CAAP,EAAUI,CAAV,GAAcjB,QAAxB,CAAlB,CA5Ee,CA4EsC;AACrD,mBAAO,OAAKH,OAAL,CAAa,EAACgB,QAAOA,OAAO,CAAP,EAAUI,CAAlB,EAAoBF,WAAUA,SAA9B,EAAwChB,WAAUA,SAAlD,EAA4DC,UAASA,QAArE,EAA8ER,IAA9E,EAAb,CAAP;AA7Ee;AA8ElB;;AAEK0B,iBAAN,CAAoBC,IAApB,EAA0B;AAAA;;AAAA;AACtB,kBAAM5B,QAAQ,OAAKA,KAAL,CAAW,WAAX,CAAd;AACAA,kBAAM6B,GAAN,GAAY,SAAZ;AACA,kBAAMC,WAAW,MAAM9B,MAAM+B,KAAN,CAAY,EAACC,WAAU,CAAC,MAAD,EAAQ,MAAIJ,IAAJ,GAAS,GAAjB,CAAX,EAAZ,EAA+CK,MAA/C,EAAvB;;AAEA,gBAAI,CAAC/B,MAAMC,OAAN,CAAc2B,QAAd,CAAL,EAA8B;AAC1B,qBAAK,IAAIP,IAAI,CAAb,EAAgBA,IAAIO,SAASnD,MAA7B,EAAqC4C,GAArC,EAA0C;AACtC,wBAAIK,OAAOE,SAASP,CAAT,EAAYS,SAAvB;AACA,0BAAM,OAAKE,KAAL,CAAWN,IAAX,EAAiB,IAAjB,CAAN;AACH;AACJ;AACD,kBAAM3B,OAAO,MAAMD,MAAM+B,KAAN,CAAY,EAACC,WAAU,CAAC,MAAD,EAAQ,MAAIJ,IAAJ,GAAS,GAAjB,CAAX,EAAZ,EAA+CO,MAA/C,EAAnB;AACA,mBAAOlC,IAAP;AAZsB;AAazB;;AAEKmC,qBAAN,GAA0B;AAAA;;AAAA;AACtB,kBAAMpC,QAAS,OAAKA,KAAL,CAAW,SAAX,CAAf;AACAA,kBAAM6B,GAAN,GAAY,WAAZ;AACA,kBAAMrB,YAAY,OAAKjB,GAAL,CAAS,WAAT,KAAyB,CAA3C;AACA,kBAAMkB,WAAW,OAAKlB,GAAL,CAAS,UAAT,KAAwB,CAAzC;AACA,kBAAME,YAAY,OAAKF,GAAL,CAAS,WAAT,CAAlB;;AAEA;AACA,kBAAM8C,WAAW,MAAM,OAAKH,KAAL,CAAW,iBAAe1B,SAAf,GAAyB,GAAzB,GAA6BC,QAAxC,CAAvB;AACA,gBAAI,CAACP,MAAMC,OAAN,CAAckC,QAAd,CAAL,EAA8B;AAC1BvC,wBAAQC,GAAR,CAAY,iBAAZ,EAA+B,iBAAeS,SAAf,GAAyB,GAAzB,GAA6BC,QAA5D;AACA,uBAAO,OAAKH,OAAL,CAAa+B,QAAb,CAAP;AACH;AACD,kBAAMpC,OAAO,MAAMD,MAAM+B,KAAN,CAAY,EAAClC,SAAQ,CAAT,EAAZ,EAAyByC,KAAzB,CAA+B,gBAA/B,EAAiDC,IAAjD,CAAsD/B,SAAtD,EAAiEC,QAAjE,EAA2E+B,WAA3E,EAAnB;;AAEA,kBAAMC,UAAU,EAAhB;AACA,iBAAK,IAAIC,IAAT,IAAiBzC,KAAKA,IAAtB,EAA4B;AACxB,oBAAIyC,KAAKpD,OAAL,IAAgB,CAApB,EAAuB;AAAE;AACrBoD,yBAAKC,IAAL,GAAY,MAAM,OAAK3C,KAAL,CAAW,SAAX,EAAsB4C,WAAtB,CAAkCF,KAAKlD,QAAvC,CAAlB;AACH,iBAFD,MAEO,IAAIkD,KAAKpD,OAAL,IAAgB,CAApB,EAAuB;AAAE;AAC5BoD,yBAAKC,IAAL,GAAY,MAAM,OAAK3C,KAAL,CAAW,UAAX,EAAuB4C,WAAvB,CAAmCF,KAAKlD,QAAxC,CAAlB;AACAkD,yBAAKG,OAAL,GAAe,MAAM,OAAK7C,KAAL,CAAW,UAAX,EAAuB+B,KAAvB,CAA6B,EAACpB,YAAW+B,KAAKlD,QAAjB,EAA7B,EAAyDsD,QAAzD,CAAkE,SAAlE,EAA6E,IAA7E,CAArB;AACH,iBAHM,MAGA,IAAIJ,KAAKpD,OAAL,IAAgB,CAApB,EAAuB;AAC1BoD,yBAAKC,IAAL,GAAY,MAAM,OAAK3C,KAAL,CAAW,QAAX,EAAqB4C,WAArB,CAAiCF,KAAKlD,QAAtC,CAAlB;AACH,iBAFM,MAEA;AACHkD,yBAAKC,IAAL,GAAY,EAAZ;AACH;AACDD,qBAAK/C,OAAL,GAAe,OAAKzB,WAAL,CAAiBwE,KAAK/C,OAAtB,CAAf;AACA;AACA+C,qBAAKK,QAAL,GAAgB,MAAM,OAAK/C,KAAL,CAAW,cAAX,EAA2B+B,KAA3B,CAAiC,EAACiB,WAAUN,KAAKO,SAAhB,EAA2BxD,WAAUA,SAArC,EAAjC,EAAkFyD,KAAlF,EAAtB;AACAR,qBAAKS,IAAL,GAAY,MAAM,OAAKnD,KAAL,CAAW,SAAX,EAAsBoD,KAAtB,CAA4B,CAAC,OAAD,EAAS,aAAT,CAA5B,EAAqDrB,KAArD,CAA2D,EAACsB,WAAUX,KAAKjD,SAAhB,EAA3D,EAAuF6D,IAAvF,EAAlB;AACAb,wBAAQc,IAAR,CAAab,IAAb;AACH;AACDzC,iBAAKA,IAAL,GAAYwC,OAAZ;AACA;AACA,kBAAM,OAAKP,KAAL,CAAW,iBAAe1B,SAAf,GAAyB,GAAzB,GAA6BC,QAAxC,EAAkDR,IAAlD,EAAwD,OAAxD,CAAN;;AAEA,kBAAM,OAAKD,KAAL,CAAW,WAAX,EAAwBK,GAAxB,CAA4B,EAAC2B,WAAU,iBAAexB,SAAf,GAAyB,GAAzB,GAA6BC,QAAxC,EAA5B,CAAN;;AAEA,mBAAO,OAAKH,OAAL,CAAaL,IAAb,CAAP;AAvCsB;AAwCzB;;AAEKuD,qBAAN,GAA0B;AAAA;;AAAA;AACtB,kBAAMrC,KAAK,OAAK5B,GAAL,CAAS,WAAT,CAAX;AACA,kBAAME,YAAY,OAAKF,GAAL,CAAS,WAAT,CAAlB;AACA,gBAAIU,OAAO,MAAM,OAAKD,KAAL,CAAW,SAAX,EAAsB+B,KAAtB,CAA4B,EAACkB,WAAU9B,EAAX,EAA5B,EAA4CmC,IAA5C,EAAjB;AACA,gBAAIG,WAAWxD,KAAKwD,QAAL,GAAgB,CAA/B;AACA,kBAAMC,OAAO,EAACD,UAASA,QAAV,EAAb;AACA,kBAAM,OAAKzD,KAAL,CAAW,SAAX,EAAsB+B,KAAtB,CAA4B,EAACkB,WAAU9B,EAAX,EAA5B,EAA4CwC,MAA5C,CAAmDD,IAAnD,CAAN;AACA,kBAAM,OAAK1D,KAAL,CAAW,cAAX,EAA2BK,GAA3B,CAA+B,EAACZ,WAAWA,SAAZ,EAAuBuD,WAAU7B,EAAjC,EAA/B,CAAN;AACA,kBAAM,OAAKQ,aAAL,CAAmB,cAAnB,CAAN;;AAEA,kBAAMiC,YAAY,MAAM,OAAK5D,KAAL,CAAW,SAAX,EAAsB+B,KAAtB,CAA4B,EAACkB,WAAU9B,EAAX,EAA5B,EAA4C2B,QAA5C,CAAqD,UAArD,EAAiE,IAAjE,CAAxB;AACA,mBAAO,OAAKe,IAAL,CAAU,EAACC,KAAI,MAAL,EAAaC,QAAOH,SAApB,EAAV,CAAP;AAXsB;AAYzB;;AAEKI,wBAAN,GAA6B;AAAA;;AAAA;AACzB,kBAAM7C,KAAK,OAAK5B,GAAL,CAAS,WAAT,CAAX;AACA,kBAAME,YAAY,OAAKF,GAAL,CAAS,WAAT,CAAlB;AACA,kBAAMU,OAAO,MAAM,OAAKD,KAAL,CAAW,cAAX,EAA2B+B,KAA3B,CAAiC,EAACiB,WAAU7B,EAAX,EAAe1B,WAAUA,SAAzB,EAAjC,EAAsEyD,KAAtE,EAAnB;AACA,mBAAO,OAAK5C,OAAL,CAAaL,IAAb,CAAP;AAJyB;AAK5B;;AA5N+B,CAApC",
    "file": "../../../src/api/controller/discuss.js",
    "sourcesContent": [
        "const Base = require('./base.js');\n\nmodule.exports = class extends Base {\n\n    uncodeUtf16(str){\n        var reg = /\\&#.*?;/g;\n        var result = str.replace(reg,function(char){\n            var H,L,code;\n            if(char.length == 9 ){\n                code = parseInt(char.match(/[0-9]+/g));\n                H = Math.floor((code-0x10000) / 0x400)+0xD800;\n                L = (code - 0x10000) % 0x400 + 0xDC00;\n                return unescape(\"%u\"+H.toString(16)+\"%u\"+L.toString(16));\n            }else{\n                return char;\n            }\n        });\n        return result;\n     }\n\n    utf16toEntities(str) {\n        var patt=/[\\ud800-\\udbff][\\udc00-\\udfff]/g;\n        // 检测utf16字符正则\n        str = str.replace(patt, function(char){\n            var H, L, code;\n            if (char.length===2) {\n                H = char.charCodeAt(0);\n                // 取出高位\n                L = char.charCodeAt(1);\n                // 取出低位\n                code = (H - 0xD800) * 0x400 + 0x10000 + L - 0xDC00;\n                // 转换算法\n                return \"&#\" + code + \";\";\n            } else {\n                return char;\n            }\n        });\n        return str;\n    }\n\n    async addAction() {\n        const distype = this.get('distype');\n        const targetid = this.get('targetid') || 0;\n        const studentid = this.get('studentid');\n        const scenerytype = this.get('scenerytype');\n        const content = this.utf16toEntities(this.post('content'));\n        const shstate = this.post('shstate') || 0;   \n\n        console.log('content', content)\n\n        const model = this.model('discuss');\n        let data = null;\n        if (think.isEmpty(scenerytype)) {\n            data = {\n                distype,targetid,studentid,content,shstate\n            }\n        } else {\n            data = {\n                distype,targetid,studentid,content,shstate,scenerytype\n            }\n        }\n\n        let insertid = await model.add(data);\n        return this.success('留言成功')\n    }\n\n    async listAction() {\n        const model =  this.model('discuss');\n        const pageindex = this.get('pageindex') || 1;\n        const pagesize = this.get('pagesize') || 5;\n        const shstate = this.get('shstate');\n        const distype = this.get('distype');\n        const sceneryid = this.get('sceneryid');\n        const activityID = this.get('activityid');\n        const schoolid = this.get('schoolid');\n        const studentid = this.get('studentid');\n\n        let typeconition = '';\n        let scenerycondition = '';\n        let activitycondition = '';\n        let schoolcondition = '';\n        let statusconditionn = '';\n        let studentcondition = '';\n\n        if (think.isEmpty(shstate)) {\n            statusconditionn = '1=1 ';\n        } else {\n            statusconditionn = 'a.shstate='+shstate\n        }\n\n        if (think.isEmpty(distype)) {\n            typeconition = '1=1 ';\n        } else {\n            let id = -1;\n            if (distype == 0) {\n                id = sceneryid;\n            } else if (distype == 1) {\n                id = activityID;\n            } else if (distype == 2) {\n                id = schoolid;\n            } else if (distype == 3) {\n                id = 0;\n            }\n            if(!think.isEmpty(id)) {\n                typeconition = 'a.distype='+distype+' and a.targetid='+id;\n            } else {\n                typeconition = 'a.distype='+distype;\n            }\n        }\n\n        if (think.isEmpty(sceneryid)) {\n            scenerycondition = '1=1 ';\n        } else {\n            scenerycondition = 'sceneryid='+sceneryid\n        }\n\n        if (think.isEmpty(activityID)) {\n            activitycondition = '1=1 ';\n        } else {\n            activitycondition = 'activityID='+activityID;\n        }\n\n        if (think.isEmpty(schoolid)) {\n            schoolcondition = '1=1 ';\n        } else {\n            schoolcondition = 'schoolID='+schoolid;\n        }\n\n        if (think.isEmpty(studentid)) {\n            studentcondition = '1=1 ';\n        } else {\n            studentcondition = 'a.studentid='+studentid;\n        }\n        const start = (pageindex -1) * pagesize;\n        const data = await model.query(\"select a.discussID,s.studentName,s.photo,a.distype,a.targetid,a.scenerytype,a.studentid,a.content,a.shstate,a.isrecommend,a.createdate, case  when distype=0 then (select scenerytitle from culture_scenery where \"+scenerycondition+\" limit 1) when distype=1 then (select activityname from culture_activity where \"+activitycondition+\" limit 1) when distype=2 then (select schoolname from culture_school where \"+schoolcondition+\" limit 1) when distype=3 then \\\"APP首页\\\" end as targetaddress from culture_discuss a left join culture_student s on s.studentid=a.studentid where \"+typeconition+\" and \"+studentcondition+\" and \"+statusconditionn+\" and a.shstate=1 order by discussID desc limit \"+start+\",\"+pagesize+\" \");\n        const counta = await model.query(\"select count(*) t from (select a.discussID,s.studentName,a.distype,a.targetid,a.studentid,a.content,a.shstate,  case  when distype=0 then (select scenerytitle from culture_scenery where \"+scenerycondition+\" limit 1) when distype=1 then (select activityname from culture_activity where \"+activitycondition+\" limit 1) when distype=2 then (select schoolname from culture_school where \"+schoolcondition+\" limit 1) when distype=3 then \\\"APP首页\\\" end as targetaddress from culture_discuss a left join culture_student s on s.studentid=a.studentid where \"+typeconition+\" and \"+studentcondition+\" and \"+statusconditionn+\" and a.shstate=1) t \");\n        if (!think.isEmpty(data) && data.length > 0) {\n            for (let i = 0; i < data.length; i++) {\n                data[i].content = this.uncodeUtf16(data[i].content);\n            }\n        }\n\n        const pagecount = Math.ceil(counta[0].t / pagesize); //(counta[0].t + parseInt(pagesize - 1)) / pagesize;\n        return this.success({counta:counta[0].t,pagecount:pagecount,pageindex:pageindex,pagesize:pagesize,data})\n    }\n\n    async getdatabyname(name) {\n        const model = this.model('pagecache');\n        model._pk = 'cacheid';\n        const dataname = await model.where({cachename:['like','%'+name+'%']}).select();\n        \n        if (!think.isEmpty(dataname)) {\n            for (let i = 0; i < dataname.length; i++) {\n                let name = dataname[i].cachename;\n                await this.cache(name, null);\n            }\n        }\n        const data = await model.where({cachename:['like','%'+name+'%']}).delete();\n        return data;\n    }\n    \n    async homeDiscussAction() {\n        const model =  this.model('discuss');\n        model._pk = \"discussID\";\n        const pageindex = this.get('pageindex') || 1;\n        const pagesize = this.get('pagesize') || 5;\n        const studentid = this.get('studentid');\n\n        // await this.cache('home_discuss'+pageindex+'_'+pagesize, null);\n        const homedata = await this.cache('home_discuss'+pageindex+'_'+pagesize);\n        if (!think.isEmpty(homedata)) {\n            console.log('read from cache', 'home_discuss'+pageindex+'_'+pagesize)\n            return this.success(homedata)\n        }\n        const data = await model.where({shstate:1}).order('discussID desc').page(pageindex, pagesize).countSelect();\n\n        const arrdata = [];\n        for (let item of data.data) {\n            if (item.distype == 0) { // 景点\n                item.pics = await this.model('scenery').getPicsbyid(item.targetid);\n            } else if (item.distype == 1) { // 活动\n                item.pics = await this.model('activity').getPicsbyid(item.targetid);\n                item.isgroup = await this.model('activity').where({activityID:item.targetid}).getField('isGroup', true);\n            } else if (item.distype == 2) {\n                item.pics = await this.model('school').getPicsbyid(item.targetid);\n            } else {\n                item.pics = []\n            }\n            item.content = this.uncodeUtf16(item.content);\n            // item.likednum = await this.model('discuss').where({discussID:item.discussID, studentid:studentid}).getField('clicknum', true);\n            item.likednum = await this.model('like_discuss').where({discussid:item.discussID, studentid:studentid}).count();\n            item.poto = await this.model('student').field(['photo','studentName']).where({studentID:item.studentid}).find();\n            arrdata.push(item)\n        }\n        data.data = arrdata;\n        // console.log('set cache')\n        await this.cache('home_discuss'+pageindex+'_'+pagesize, data, 'redis')\n\n        await this.model('pagecache').add({cachename:'home_discuss'+pageindex+'_'+pagesize});\n\n        return this.success(data)\n    }\n\n    async likediscussAction() {\n        const id = this.get('discussid');\n        const studentid = this.get('studentid');\n        let data = await this.model('discuss').where({discussID:id}).find();\n        let clicknum = data.clicknum + 1;\n        const para = {clicknum:clicknum};\n        await this.model('discuss').where({discussID:id}).update(para);\n        await this.model('like_discuss').add({studentid: studentid, discussid:id});\n        await this.getdatabyname('home_discuss');\n\n        const clickdata = await this.model('discuss').where({discussID:id}).getField('clicknum', true)\n        return this.json({msg:'点赞成功', newnum:clickdata});\n    }\n\n    async hasLikeDiscussAction() {\n        const id = this.get('discussid');\n        const studentid = this.get('studentid');\n        const data = await this.model('like_discuss').where({discussid:id, studentid:studentid}).count();\n        return this.success(data)\n    }\n    \n}"
    ]
}