{
    "version": 3,
    "sources": [
        "../../../src/api/controller/group.js"
    ],
    "names": [
        "Base",
        "require",
        "_",
        "module",
        "exports",
        "addEditAction",
        "id",
        "post",
        "groupname",
        "studentid",
        "think",
        "isEmpty",
        "fail",
        "groupstudnetData",
        "model",
        "where",
        "activityid",
        "select",
        "dataExsts",
        "groupName",
        "data",
        "length",
        "param",
        "insertid",
        "add",
        "para2",
        "groupid",
        "insertidgr",
        "success",
        "readyScanAction",
        "get",
        "cache",
        "showGroupAction",
        "joinGroupAction",
        "para",
        "hasCreateGroup",
        "hasjoinData",
        "field",
        "activityID",
        "getField",
        "scanstudnetid",
        "actData",
        "find",
        "groupnum",
        "parseInt",
        "groupNum",
        "groupcount",
        "uniq",
        "console",
        "log",
        "groupdate",
        "msg",
        "display",
        "showQrAction",
        "url",
        "qrService",
        "service",
        "type",
        "body",
        "getQrByUrl"
    ],
    "mappings": "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",
    "file": "../../../src/api/controller/group.js",
    "sourcesContent": [
        "const Base = require('./base.js');\nconst _ = require('lodash');\n\nmodule.exports = class extends Base {\n    async addEditAction() {\n        const id = this.post('id');\n        const groupname = this.post('groupname');\n        const studentid = this.post('studentid')\n\n        if (think.isEmpty(groupname)) {\n            return this.fail('团队名称必填')\n        }\n\n        // 有没有加入团队\n        const groupstudnetData = await this.model('student_group').where({activityid: id, studentid: studentid}).select();\n        if (!think.isEmpty(groupstudnetData)) {\n            // console.log('groupstudnetData', groupstudnetData)\n            // groupstudnetData.groupname = await this.model('group').field('groupName').where({groupID: groupstudnetData[0].groupid}).find()\n            return this.fail('你已加入过团队,不能再创建团队')\n        }\n        \n        const dataExsts = await this.model('group').where({groupName: groupname}).select();\n        if (dataExsts && dataExsts.data && dataExsts.data.length > 0) {\n            return this.fail('团队名称重复,添加失败')\n        }\n        let param = {\n            activityid:id,\n            groupName:groupname,\n            studentid: studentid\n        }\n\n        const insertid = await this.model('group').add(param);\n        if (!think.isEmpty(insertid)) {\n            let para2 = {\n                groupid:insertid,studentid:studentid,activityid:id\n            }\n            let insertidgr = await this.model('student_group').add(para2);\n        }\n        return this.success('添加成功')\n    }\n\n    async readyScanAction() {\n        const studentid = this.get('studentid');\n        this.cache('scan'+studentid, studentid);\n        // console.log('readyScanAction-------------------')\n        return this.success({'scan': studentid})\n    }\n\n    async showGroupAction() {\n        const groupid = this.get('groupid');\n        return this.success({groupid: groupid})\n    }\n\n    async joinGroupAction() {\n        const groupid = this.get('groupid');\n        const studentid = this.get('studentid');\n        const activityid = this.get('activityid');\n        let para = {\n            groupid,studentid,activityid\n        }\n\n        const hasCreateGroup = await this.model('group').where({groupid: groupid, studentid:studentid, activityid: activityid}).select();\n        if (!think.isEmpty(hasCreateGroup)) {\n            return this.fail('你已创建团队,不能再加入团队')\n        }\n        const hasjoinData = await this.model('student_group').field('studentid').where({activityID: activityid, studentid: studentid}).getField('studentid');\n        if (!think.isEmpty(hasjoinData)) {\n            return this.fail('你已加过团队,不能再加入团队')\n        }\n\n        const scanstudnetid = await this.cache('scan'+studentid);\n        // console.log('joinGroup.scanstudnetid-----', scanstudnetid, groupid,studentid,activityid)\n        if (!think.isEmpty(scanstudnetid)) {  \n            this.cache('scan'+studentid, null);\n                  \n            const actData = await this.model('activity').field(['activityID','groupNum']).where({activityID: activityid}).find();\n            let groupnum = 0\n            if (!think.isEmpty(actData)) {\n                groupnum = parseInt(actData.groupNum);\n            }\n\n            let groupcount = await this.model('student_group').field('studentid').where({activityID: activityid, groupid: groupid}).getField('studentid');\n            groupcount = _.uniq(groupcount);\n            console.log('groupcount=====', groupcount, groupnum)\n            if (groupcount.length >= groupnum) {\n                return this.fail('加入失败, 超过团体活动最大限制人数')\n            } else {\n                console.log('joingroup------',groupid,studentid,activityid)\n                // console.log('success group----')\n                let insertid = await this.model('student_group').add(para);\n                const groupdate = await this.model('group').where({groupid: groupid}).find();\n                return this.success({msg:'扫码加入成功',groupName: groupdate.groupName});\n            }\n        } else {\n            return this.display('pages/groupSuccess')\n        }\n    }\n\n    async showQrAction() {\n        const url = this.get('url');\n        const studentid = this.get('studentid');\n        const activityid = this.get('activityid');\n\n        \n        console.log('showqr', url, studentid, activityid)\n        \n            \n            const qrService = this.service('qr', 'api');\n            this.type = 'image/svg+xml';\n            this.body = qrService.getQrByUrl(url+'&studentid='+studentid+'&activityid='+activityid);\n        \n    }\n}"
    ]
}