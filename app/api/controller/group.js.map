{
    "version": 3,
    "sources": [
        "../../../src/api/controller/group.js"
    ],
    "names": [
        "Base",
        "require",
        "_",
        "module",
        "exports",
        "addEditAction",
        "id",
        "post",
        "groupname",
        "studentid",
        "think",
        "isEmpty",
        "fail",
        "groupstudnetData",
        "model",
        "where",
        "activityid",
        "select",
        "dataExsts",
        "groupName",
        "length",
        "param",
        "insertid",
        "add",
        "para2",
        "groupid",
        "insertidgr",
        "success",
        "readyScanAction",
        "get",
        "cache",
        "showGroupAction",
        "joinGroupAction",
        "para",
        "hasCreateGroup",
        "hasjoinData",
        "field",
        "activityID",
        "getField",
        "scanstudnetid",
        "actData",
        "find",
        "groupnum",
        "parseInt",
        "groupNum",
        "groupcount",
        "uniq",
        "console",
        "log",
        "groupdate",
        "hasbaomin",
        "studentID",
        "para3",
        "shstate",
        "insertid2",
        "msg",
        "display",
        "showQrAction",
        "url",
        "qrService",
        "service",
        "type",
        "body",
        "getQrByUrl"
    ],
    "mappings": "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",
    "file": "../../../src/api/controller/group.js",
    "sourcesContent": [
        "const Base = require('./base.js');\nconst _ = require('lodash');\n\nmodule.exports = class extends Base {\n    async addEditAction() {\n        const id = this.post('id');\n        const groupname = this.post('groupname');\n        const studentid = this.post('studentid')\n\n        if (think.isEmpty(groupname)) {\n            return this.fail('团队名称必填')\n        }\n\n        // 有没有加入团队\n        const groupstudnetData = await this.model('student_group').where({activityid: id, studentid: studentid}).select();\n        if (!think.isEmpty(groupstudnetData)) {\n            // console.log('groupstudnetData', groupstudnetData)\n            // groupstudnetData.groupname = await this.model('group').field('groupName').where({groupID: groupstudnetData[0].groupid}).find()\n            return this.fail('你已加入过团队,不能再创建团队')\n        }\n        \n        const dataExsts = await this.model('group').where({groupName: groupname, activityid:id}).select();\n        if (dataExsts && dataExsts.length > 0) {\n            return this.fail('团队名称被抢注,请更换')\n        }\n        let param = {\n            activityid:id,\n            groupName:groupname,\n            studentid: studentid\n        }\n\n        const insertid = await this.model('group').add(param);\n        if (!think.isEmpty(insertid)) {\n            let para2 = {\n                groupid:insertid,studentid:studentid,activityid:id\n            }\n            let insertidgr = await this.model('student_group').add(para2);\n        }\n        return this.success('添加成功')\n    }\n\n    async readyScanAction() {\n        const studentid = this.get('studentid');\n        this.cache('scan'+studentid, studentid);\n        // console.log('readyScanAction-------------------')\n        return this.success({'scan': studentid})\n    }\n\n    async showGroupAction() {\n        const groupid = this.get('groupid');\n        return this.success({groupid: groupid})\n    }\n\n    async joinGroupAction() {\n        const groupid = this.get('groupid');\n        const studentid = this.get('studentid');\n        const activityid = this.get('activityid');\n        let para = {\n            groupid,studentid,activityid\n        }\n\n        const hasCreateGroup = await this.model('group').where({groupid: groupid, studentid:studentid, activityid: activityid}).select();\n        if (!think.isEmpty(hasCreateGroup)) {\n            return this.fail('你已创建团队,不能再加入团队')\n        }\n        const hasjoinData = await this.model('student_group').field('studentid').where({activityID: activityid, studentid: studentid}).getField('studentid');\n        if (!think.isEmpty(hasjoinData)) {\n            return this.fail('你已加过团队,不能再加入团队')\n        }\n\n        const scanstudnetid = await this.cache('scan'+studentid);\n        // console.log('joinGroup.scanstudnetid-----', scanstudnetid, groupid,studentid,activityid)\n        if (!think.isEmpty(scanstudnetid)) {  \n            this.cache('scan'+studentid, null);\n                  \n            const actData = await this.model('activity').field(['activityID','groupNum']).where({activityID: activityid}).find();\n            let groupnum = 0\n            if (!think.isEmpty(actData)) {\n                groupnum = parseInt(actData.groupNum);\n            }\n\n            let groupcount = await this.model('student_group').field('studentid').where({activityID: activityid, groupid: groupid}).getField('studentid');\n            groupcount = _.uniq(groupcount);\n            console.log('groupcount=====', groupcount, groupnum)\n            if (groupcount.length >= groupnum) {\n                return this.fail('加入失败, 超过团体活动最大限制人数')\n            } else {\n                console.log('joingroup------',groupid,studentid,activityid)\n                // console.log('success group----')\n                let insertid = await this.model('student_group').add(para);\n                const groupdate = await this.model('group').where({groupid: groupid}).find();\n\n                // 报名\n                let hasbaomin = await this.model('student_activity').where({activityid:activityid,studentID:studentid}).find();\n                if (think.isEmpty(hasbaomin)) {\n                    let para3 = {\n                        studentID:studentid,activityid:activityid,shstate:1\n                    }\n                    let insertid2 = await this.model('student_activity').add(para3);\n                }\n                return this.success({msg:'扫码加入成功',groupName: groupdate.groupName});\n            }\n        } else {\n            return this.display('pages/groupSuccess')\n        }\n    }\n\n    async showQrAction() {\n        const url = this.get('url');\n        const studentid = this.get('studentid');\n        const activityid = this.get('activityid');\n\n        \n        console.log('showqr', url, studentid, activityid)\n        \n            \n            const qrService = this.service('qr', 'api');\n            this.type = 'image/svg+xml';\n            this.body = qrService.getQrByUrl(url+'&studentid='+studentid+'&activityid='+activityid);\n        \n    }\n}"
    ]
}