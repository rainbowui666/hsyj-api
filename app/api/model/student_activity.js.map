{
    "version": 3,
    "sources": [
        "../../../src/api/model/student_activity.js"
    ],
    "names": [
        "_",
        "require",
        "module",
        "exports",
        "think",
        "Model",
        "getActivityHasJoin",
        "studentid",
        "activityid",
        "shstate",
        "data",
        "model",
        "where",
        "studentID",
        "select",
        "getStudentIsJoinActivity",
        "actData",
        "field",
        "activityID",
        "find",
        "needschoolpass",
        "needscenerypass",
        "isEmpty",
        "needSchoolPass",
        "needSceneryPass",
        "realattentscenery",
        "dataScenery",
        "getField",
        "length",
        "uniq",
        "dataschool",
        "join",
        "sceneryID",
        "iscomplate",
        "isAttentention",
        "databm",
        "console",
        "log",
        "studentJoinActivityAndAnswer",
        "questionid",
        "questiondata",
        "questionID",
        "getJoinNum",
        "getStudentIsJoinGroup",
        "needgroupnum",
        "groupNum",
        "checkindata",
        "strcheckinstudentids",
        "arr",
        "i",
        "strScenerys",
        "includes",
        "parseInt",
        "push",
        "gosceneries",
        "schoolbelong",
        "pass"
    ],
    "mappings": "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",
    "file": "../../../src/api/model/student_activity.js",
    "sourcesContent": [
        "const _ = require('lodash');\n\nmodule.exports = class extends think.Model {\n    async getActivityHasJoin(studentid, activityid, shstate) {\n        const data = await this.model('student_activity').where({studentID: studentid, activityid: activityid, shstate: shstate}).select();\n        return data\n    }\n    // 活动的景点签到\n    async getStudentIsJoinActivity(studentid, activityid, shstate) {\n        // 取景点阀值\n        const actData = await this.model('activity').field(['activityID','needSchoolPass','needSceneryPass']).where({activityID: activityid}).find();\n        let needschoolpass = 0;\n        let needscenerypass = 0;\n        if (!think.isEmpty(actData)) {\n            needschoolpass = actData.needSchoolPass;\n            needscenerypass = actData.needSceneryPass;\n        }\n\n        // 活动景点签到次数\n        let realattentscenery = 0; \n        let dataScenery = await this.model('attention_activity').field('sceneryid').where({studentid:studentid,activityid:activityid}).getField('sceneryid');\n        if (!think.isEmpty(dataScenery)) {\n            realattentscenery = dataScenery.length;\n        }\n\n        dataScenery = _.uniq(dataScenery)\n        // console.log('dataScenery------',dataScenery)\n\n        // 景点所属学校\n        let dataschool = 0;\n        if (!think.isEmpty(dataScenery)) {\n            dataScenery = dataScenery.join(',');\n            dataschool = await this.model('scenery').field('schoolid').where({sceneryID: ['in', dataScenery]}).getField('schoolid');\n            dataschool = _.uniq(dataschool)\n            // console.log('schoolid------',dataschool)\n        }\n\n        let iscomplate = false;\n        if (realattentscenery >= needscenerypass && dataschool && dataschool.length >= needschoolpass) {\n            iscomplate = true;\n        }\n\n        let isAttentention = false;\n        const databm = await this.model('student_activity').where({studentID: studentid,activityid:activityid,shstate:shstate}).select();\n        if (!think.isEmpty(databm) && databm.length > 0) {\n            isAttentention = true;\n        }\n            \n        // if (realattentscenery > 0) {\n        //     isAttentention = true;\n        // }\n        // const data = await this.model('student_activity').where({studentID: studentid, activityid: activityid, shstate: shstate}).select();\n        console.log('getActivityHasJoin-----',studentid,activityid,isAttentention,iscomplate)\n        return {isAttentention, iscomplate};\n    }\n\n    async studentJoinActivityAndAnswer(studentid, activityid,questionid) {\n        const data = await this.model('student_activity').where({studentID:studentid,activityid:activityid,shstate:1}).select();\n        const questiondata = await this.model('question').where({questionID:questionid}).select();\n\n        return {\n            data,questiondata\n        }\n    }\n\n    async getJoinNum(activityid) {\n        const data = await this.model('student_activity').where({activityid:activityid, shstate:1}).select();\n        return data ? data.length : 0;\n    }\n\n    // 团体活动每个人都要完成阀值才算完成\n    async getStudentIsJoinGroup(studentid, activityid, shstate) {\n        // 取景点阀值和人数\n        const actData = await this.model('activity').field(['activityID','needSchoolPass','needSceneryPass','groupNum']).where({activityID: activityid}).find();\n        let needschoolpass = 0;\n        let needscenerypass = 0;\n        let needgroupnum = 0;\n        if (!think.isEmpty(actData)) {\n            needschoolpass = actData.needSchoolPass;\n            needscenerypass = actData.needSceneryPass;\n            needgroupnum = actData.groupNum;\n        }\n\n        // 查找有哪些同学签过到, studentid应该包括在内\n        let checkindata = await this.model('attention_activity').field('studentid').where({activityid:activityid}).getField('studentid');\n        let strcheckinstudentids = '';\n        if (!think.isEmpty(checkindata)) {\n            checkindata = _.uniq(checkindata);\n            // strcheckinstudentids = checkindata.join(',')\n        }\n\n        let arr = [];\n        for (let i = 0; i < checkindata.length; i ++) {\n            // 活动景点签到次数\n            let realattentscenery = 0; \n            let dataScenery = await this.model('attention_activity').field('sceneryid').where({studentid:checkindata[i],activityid:activityid}).getField('sceneryid');\n            if (!think.isEmpty(dataScenery)) {\n                realattentscenery = dataScenery.length;\n            }\n            dataScenery = _.uniq(dataScenery);\n\n            // 景点所属学校\n            let dataschool = 0;\n            let strScenerys = '';\n            if (!think.isEmpty(dataScenery)) {\n                strScenerys = dataScenery.join(',');\n                dataschool = await this.model('scenery').field('schoolid').where({sceneryID: ['in', strScenerys]}).getField('schoolid');\n                dataschool = _.uniq(dataschool)\n                // console.log('schoolid------',dataschool, dataScenery)\n            }\n\n            if (checkindata.includes(parseInt(checkindata[i]))) {\n                if (dataScenery.length >= needscenerypass && dataschool.length >= needschoolpass) {\n                    arr.push({studentid: checkindata[i], gosceneries: dataScenery, schoolbelong: dataschool, pass: true});\n                } else {\n                    arr.push({studentid: checkindata[i], gosceneries: dataScenery, schoolbelong: dataschool, pass: false});\n                }\n            }\n        }\n\n        let isAttentention = false;\n        let iscomplate = false;\n        if (arr.length >= needgroupnum) {\n            for (let i = 0; i < arr.length; i++) {\n                if (!arr[i].pass) {\n                    iscomplate = false;\n                    break;\n                } else {\n                    iscomplate = true;\n                }\n            }\n        }\n\n        // if (checkindata.includes(parseInt(studentid))) {\n            const databm = await this.model('student_activity').where({studentID: studentid,activityid:activityid,shstate:shstate}).select();\n            if (!think.isEmpty(databm) && databm.length > 0) {\n                isAttentention = true;\n            }\n        // } else {\n        //     iscomplate = false;\n        // }\n\n        \n        \n        // const data = await this.model('student_activity').where({studentID: studentid,activityid:activityid,shstate:shstate}).select();\n        console.log('getStudentIsJoinGroup-----', arr, isAttentention, iscomplate, needschoolpass,needscenerypass, needgroupnum)\n        return {isAttentention, iscomplate};\n    }\n}"
    ]
}